---
description: 'Implementation plan template for feature development'
---

# Implementation Plan: Section Draft Persistence

**Branch**: `[010-epic-2-story-5]` | **Date**: 2025-09-30 | **Spec**:
`/specs/010-epic-2-story-5/spec.md`  
**Input**: Feature specification from `/specs/010-epic-2-story-5/spec.md`

## Execution Flow (/plan command scope)

```
1. Load feature spec from Input path
   → If not found: ERROR "No feature spec at {path}"
2. Fill Technical Context (scan for NEEDS CLARIFICATION)
   → Detect Project Type from file system structure or context
     (web=frontend+backend, mobile=app+api)
   → Set Structure Decision based on project type
3. Fill the Constitution Check section based on the content of the
   constitution document.
4. Evaluate Constitution Check section below
   → If violations exist: Document in Complexity Tracking
   → If no justification possible: ERROR "Simplify approach first"
   → Update Progress Tracking: Initial Constitution Check
5. Execute Phase 0 → research.md
   → If NEEDS CLARIFICATION remain: ERROR "Resolve unknowns"
6. Execute Phase 1 → contracts, data-model.md, quickstart.md,
   agent-specific template file (e.g., `CLAUDE.md` for Claude Code,
   `.github/copilot-instructions.md` for GitHub Copilot, `GEMINI.md` for
   Gemini CLI, `QWEN.md` for Qwen Code or `AGENTS.md` for opencode).
7. Re-evaluate Constitution Check section
   → If new violations: Refactor design, return to Phase 1
   → Update Progress Tracking: Post-Design Constitution Check
8. Plan Phase 2 → Describe task generation approach (DO NOT create
   tasks.md)
9. STOP - Ready for /tasks command
```

**IMPORTANT**: The /plan command STOPS at step 7. Phases 2-4 are executed by
other commands:

- Phase 2: /tasks command creates tasks.md
- Phase 3-4: Implementation execution (manual or via tools)

## Summary

Section draft persistence keeps an author's in-progress edits resident on the
client across navigation, reloads, and intermittent connectivity while bundling
saves into a single validation cycle. The plan extends the existing document
editor to surface draft status, recover drafts on load, and bundle quality-gated
saves, while the backend only processes approved submissions. Telemetry stays on
client consoles, compliance warnings trigger without sending draft content,
browser storage limits drive pruning behavior, and logout flows clear drafts
after offering revert-to-published safeguards.

## Technical Context

**Language/Version**: TypeScript 5.x (React 19 web client, Node 20 Express
API)  
**Primary Dependencies**: React 19, TanStack Query 5, Zustand, Milkdown 7,
Vercel AI SDK, Express 5, packages/editor-persistence  
**Storage**: Client-only draft cache via IndexedDB (editor-persistence) plus
backend SQLite for committed documents  
**Testing**: Vitest (unit/contract), Playwright fixture suites, pnpm test
`gauntlet`  
**Target Platform**: Browser (desktop web) + local Express server  
**Project Type**: web (frontend + backend + shared packages)  
**Performance Goals**: Draft rehydration best-effort (no SLA) yet designed to
hydrate typical documents within ~3s over local disk  
**Constraints**: Draft content must never leave client by default, status cues
must be accessible (text + ARIA), logout must purge drafts immediately,
compliance warnings log without auto-sync, honor browser quota for pruning  
**Scale/Scope**: Multi-section architecture documents per project; expect dozens
of sections with per-author draft caches

## Constitution Check

- **Library-First Architecture**: Persist logic lives in
  `packages/editor-persistence` and compliance hooks in `packages/qa`; frontend
  and backend consume libraries.
- **CLI Interface Standard**: Extend persistence package CLI (if needed) to
  inspect local draft keys so agents can validate behavior without UI.
- **Test-First Development**: Author failing Vitest suites for persistence
  store, conflict handling, telemetry logging, and API bundling before
  implementation.
- **Observability & Compliance**: Follow constitution logging rules while
  preserving client-only content; compliance warnings surface via existing QA
  logging channel.
- **Simplicity & Versioning**: Reuse existing document editor flows, add minimal
  hooks for drafts and pruning; no new services introduced.

Constitution Gate Status: PASS (no violations identified).

## Project Structure

### Documentation (this feature)

```
specs/010-epic-2-story-5/
├── plan.md
├── research.md
├── data-model.md
├── quickstart.md
├── contracts/
│   └── draft-save.openapi.yaml
└── tasks.md (generated by /tasks)
```

### Source Code (repository root)

```
apps/web/
├── src/features/document-editor/
│   ├── components/section-draft/
│   ├── hooks/use-draft-persistence.ts
│   ├── stores/draft-state.ts
│   └── utils/draft-conflict.ts
├── src/lib/telemetry/
│   └── client-events.ts
└── tests/
    ├── unit/document-editor/
    └── e2e/document-editor/

apps/api/
├── src/routes/documents/save-drafts.ts
├── src/services/drafts/
└── tests/contracts/documents/

packages/editor-persistence/
├── src/
│   ├── draft-store.ts
│   ├── schema.ts
│   └── cli.ts
└── tests/

packages/qa/
├── src/compliance/
└── tests/
```

**Structure Decision**: Web monorepo—extend document editor in `apps/web`,
surface validation routes in `apps/api`, and centralize persistence logic in
shared packages.

## Phase 0: Outline & Research

1. Unknowns from Technical Context: none remain; research focuses on verifying
   IndexedDB quota handling, ARIA live messaging patterns, and compliance log
   pathways.
2. Research tasks executed (see `research.md`): draft key schema selection,
   browser quota detection strategies, ARIA live region announcement cadence,
   compliance warning integration, and save bundle validation ordering.
3. Findings consolidated in `research.md` with decisions, rationale, and
   alternative analysis.

**Output**: `/specs/010-epic-2-story-5/research.md`

## Phase 1: Design & Contracts

1. Entities documented in `data-model.md`: DocumentDraftState, SectionDraft,
   DraftBundle, DraftValidationResult, ComplianceWarning.
2. API contracts defined in
   `/specs/010-epic-2-story-5/contracts/draft-save.openapi.yaml` covering
   bundled saves and compliance warning logging.
3. Contract tests (Vitest) planned per endpoint to assert schema obligations.
4. Quickstart scenario (`quickstart.md`) guides authors through editing, offline
   recovery, pruning, logout-triggered purge, revert-to-published behaviour, and
   compliance warning observation.

**Output**: data-model.md, contracts/draft-save.openapi.yaml, quickstart.md

## Phase 2: Task Planning Approach

**Task Generation Strategy**:

- Use `/templates/tasks-template.md` to seed numbering.
- Derive tasks from data-model entities, contracts, and quickstart steps.
- Mark persistence library updates and frontend UI changes as parallelizable [P]
  when touching isolated files.

**Ordering Strategy**:

- Author contract and unit tests for persistence and API first.
- Implement package-level logic, then backend routes, then frontend hooks/UI.
- Finish with telemetry and accessibility polish before E2E fixtures.

**Estimated Output**: 24–28 ordered tasks in `tasks.md`.

## Phase 3+: Future Implementation

Beyond `/plan` scope—/tasks populates actionable tasks, then implementation and
validation follow constitutional TDD cadence with full gauntlet verification.

## Complexity Tracking

_No constitutional deviations identified; table intentionally left empty._

| Violation | Why Needed | Simpler Alternative Rejected Because |
| --------- | ---------- | ------------------------------------ |
| —         | —          | —                                    |

## Progress Tracking

**Phase Status**:

- [x] Phase 0: Research complete (/plan command)
- [x] Phase 1: Design complete (/plan command)
- [x] Phase 2: Task planning complete (/plan command - describe approach only)
- [x] Phase 3: Tasks generated (/tasks command)
- [x] Phase 4: Implementation complete
- [x] Phase 5: Validation passed

**Gate Status**:

- [x] Initial Constitution Check: PASS
- [x] Post-Design Constitution Check: PASS
- [x] All NEEDS CLARIFICATION resolved
- [x] Complexity deviations documented

**Runtime Notes**:

- Draft rehydration now flows through the shared `DraftStore`; local harness
  measurements keep recovery well below the 3s target and broadcast guidance
  when quota pruning triggers follow-up messaging.

---

_Based on Constitution v2.1.1 - See `SPEC_KIT_CONFIG.constitution.path`_
