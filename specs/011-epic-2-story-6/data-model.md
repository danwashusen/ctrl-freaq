# Data Model â€” Conversational Co-Authoring Integration

> **Note:** The canonical entity name is `SectionConversationSession` (previous
> drafts referenced a "Section Conversation Thread").

## Entity: SectionConversationSession

| Field            | Type          | Description                                         |
| ---------------- | ------------- | --------------------------------------------------- |
| `sessionId`      | UUID          | Client-generated identifier for the active session. |
| `documentId`     | string        | UUID/slug of the document in focus.                 |
| `sectionId`      | string        | Stable identifier for the section.                  |
| `authorId`       | string        | Clerk user ID for the author driving the session.   |
| `startedAt`      | ISO timestamp | Session start time.                                 |
| `activeIntent`   | enum          | `explain` \| `outline` \| `improve`                 |
| `contextSources` | string[]      | Knowledge item identifiers selected by the author.  |
| `streamState`    | enum          | `idle` \| `streaming` \| `awaiting-approval`.       |
| `lastTurnId`     | string?       | Reference to the most recent conversation turn.     |

Relationships:

- One `SectionConversationSession` aggregates multiple `ConversationTurn`
  records while the session is active.
- Session state is kept client-side; backend receives `sessionId` only to label
  responses and audit metadata.

## Entity: ConversationTurn

| Field          | Type          | Description                                    |
| -------------- | ------------- | ---------------------------------------------- |
| `turnId`       | string        | Deterministic ID (sessionId + counter).        |
| `sessionId`    | UUID          | Foreign key to `SectionConversationSession`.   |
| `speaker`      | enum          | `author` \| `assistant` \| `system`.           |
| `intent`       | enum          | Mirrors `activeIntent` for traceability.       |
| `promptText`   | string        | Text supplied by the author.                   |
| `responseText` | string?       | AI response summarized client-side.            |
| `citations`    | string[]      | Document decision IDs or knowledge references. |
| `confidence`   | number?       | 0-1 float expressing model confidence.         |
| `createdAt`    | ISO timestamp | When the turn was recorded client-side.        |

Constraints:

- Turns are ephemeral; only logged in-memory and exported to changelog metadata
  when a proposal is approved.

## Entity: ProviderContextPayload

| Field                                         | Type                                         | Description                                  |
| --------------------------------------------- | -------------------------------------------- | -------------------------------------------- |
| `documentId`                                  | string                                       | Document identifier forwarded to provider.   |
| `sectionId`                                   | string                                       | Focused section identifier.                  |
| `documentTitle`                               | string                                       | Title for prompting clarity.                 |
| `completedSections`                           | Array<{ `path`: string, `content`: string }> | Ordered                                      |
| list of completed sections included verbatim. |
| `currentDraft`                                | string                                       | Latest draft content for the active section. |
| `decisionSummaries`                           | Array<{ `id`: string, `summary`: string }>   | Selected                                     |
| decision log summaries.                       |
| `knowledgeItems`                              | Array<{ `id`: string, `excerpt`: string }>   | Optional                                     |
| knowledge snippets chosen by the author.      |
| `clarifications`                              | string[]                                     | Relevant clarifications (from spec) echoed.  |

Usage:

- Passed to the AI provider with the user prompt; excluded from telemetry and
  logs except for metadata counts.

## Entity: AIProposalSnapshot

| Field          | Type          | Description                                        |
| -------------- | ------------- | -------------------------------------------------- |
| `proposalId`   | UUID          | Identifier reported to frontend + changelog.       |
| `sessionId`    | UUID          | Source conversation session.                       |
| `originTurnId` | string        | Conversation turn that requested the proposal.     |
| `diff`         | PatchDiff[]   | Git-style diff segments generated by editor-core.  |
| `renderMode`   | enum          | `split` \| `unified`.                              |
| `confidence`   | number        | Model confidence scalar (0-1).                     |
| `citations`    | string[]      | Document decision or knowledge references.         |
| `createdAt`    | ISO timestamp | When proposal returned from backend.               |
| `expiresAt`    | ISO timestamp | Session validity window; proposal discarded after. |

Constraints:

- Proposal snapshots exist only while session active; approval moves metadata
  into the changelog entry and draft persistence queue.

## Entity: DiffPreviewAnnotation

| Field          | Type   | Description                                   |
| -------------- | ------ | --------------------------------------------- |
| `segmentId`    | string | Derived from `proposalId` + diff index.       |
| `segmentType`  | enum   | `added` \| `removed` \| `context`.            |
| `originTurnId` | string | Conversation turn responsible for the change. |
| `rationale`    | string | Short bullet referencing citations/decisions. |
| `severityFlag` | enum?  | Optional review hint (`minor`, `major`).      |

Usage:

- Drives UI badges on diff preview and later populates audit logs when approved.

## Entity: SectionChangelogEntry (Extended)

| Field           | Type          | Description                             |
| --------------- | ------------- | --------------------------------------- |
| `entryId`       | UUID          | Existing changelog primary key.         |
| `documentId`    | string        | Document identifier.                    |
| `sectionId`     | string        | Section identifier.                     |
| `approvedBy`    | string        | Clerk user ID approving the proposal.   |
| `approvedAt`    | ISO timestamp | Timestamp of approval.                  |
| `proposalId`    | UUID          | Back-reference to `AIProposalSnapshot`. |
| `promptSummary` | string        | Author prompt summary or intent label.  |
| `citations`     | string[]      | References relied on during approval.   |
| `confidence`    | number        | Model confidence at approval time.      |
| `diffHash`      | string        | Hash of applied diff for replay.        |

Lifecycle:

- Created when author approves a proposal; diff applied to draft persistence and
  entry stored for audit.

## Derived Views

### Frontend Session Store Snapshot

| Selector                        | Returns                      |
| ------------------------------- | ---------------------------- | ------------------------- |
| `selectActiveSession()`         | `SectionConversationSession` |
| `selectTurns()`                 | `ConversationTurn[]`         |
| `selectPendingProposal()`       | `AIProposalSnapshot          | null`                     |
| `selectProgress()`              | `{ status: 'idle'            | 'streaming', elapsedMs }` |
| `selectAnnotations(proposalId)` | `DiffPreviewAnnotation[]`    |

### Backend Audit Event Payload

| Field        | Type    | Description                                                     |
| ------------ | ------- | --------------------------------------------------------------- |
| `event`      | enum    | `coauthor.intent` \| `coauthor.proposal` \| `coauthor.approved` |
| `documentId` | string  | Document identifier.                                            |
| `sectionId`  | string  | Section identifier.                                             |
| `authorId`   | string  | Acting author.                                                  |
| `sessionId`  | UUID    | Session correlation.                                            |
| `proposalId` | UUID?   | Present for proposal/approved events.                           |
| `intent`     | string  | Intent code (explain/outline/improve).                          |
| `responseMs` | number? | Duration until first token (ms).                                |
| `confidence` | number? | Model confidence.                                               |

All audit payloads omit transcript text and diff content, referencing store
locations instead.
